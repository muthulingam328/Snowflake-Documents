# Architecture #

Snowflake's architecture is a hybrid of traditional shared-disk and shared-nothing database architectures.
* Similar to shared-disk architectures:
  * Snowflake uses a central data repository for persisted data accessible from all compute nodes in the platform
  * Offers data management simplicity
* Similar to shared-nothing architectures (e.g. Hadoop, Spark)
  * Snowflake processes queries using virtual warehouses where each node in the cluster stores a portion of the entire data set locally
  * Offers performance and scale-out benefits

Advantages:
* Storage, compute and management services are decoupled and can scale independently
* There is virtually no limit on how much each layer can be scaled
* Workload isolation with virtual warehouses

## Snowflake Layers ##
Snowflake's unique architecture consists of three layers, all of them with High Availability. The price is also charged separately for each layer.

> In addition to the three layers mentioned, there is the Cloud Agnostic Layer - allows Snowflake to run on the major cloud providers: AWS, Azure, GCP and ensures Snowflake performs comparaby across providers.

![](../images/SnowflakeLayers.png)

### Storage Layer ###
* single copy and source of truth for the data
* virtually infinitely scalable
* inherits the cloud provider's availability and durability guarantees
  * e.g. AWS S3 replicates data across three different availability zones within a region
* data is stored in Snowflake's read-optimized proprietary compressed columnar format
  * due to columns containing similar data, the columnar format results in better compression
  * data is stored compressed
  * data is stored using AES-256 encryption
* Snowflake manages all aspects of how this data is stored.

### Compute (Query Processing) Layer ###
* Multi-Cluster Compute (Virtual Warehouses): each Virtual Warehouse is a Massively Parallel Processing (MPP) compute cluster composed of multiple compute nodes allocated by Snowflake from a cloud provider.
* Carries out the computation of the query plan generated by the Cloud Services Layer.
* Virtual Warehouses retrieve the data required for processing a query and cache it locally for up to 24 hours
* Virtual Warehouses can be created or removed almost instantly
* VWs can also be paused or resumed as needed
* The customer is only charged for the time the VW is running
* Each Warehouse is isolated from others and can be configured individually

### Cloud Services Layer ###
Also known as the Global Services Layer, it is a collection of highly available and scalable services that manages all activities across Snowflake. The Cloud Services Layer is shared between accounts (other than accounts setup with a Virtual Private Snowflake Edition)
* Security
  * Authentication
  * Access Control
    * Roles and Users
    * Shares
  * data encryption and key rotation
* Infrastructure management
  * Compute
  * Centralized storage
    * Micropartitions
    * Micropartition versioning for Time Travel
* Transaction management (ACID compliant)
* Query parsing and optimization
  * SQL Optimization
    * Cost-based
    * Automatic `JOIN` order optimization (no hints required)
    * Automatic statistics gathering
    * Data Pruning based on the metadata and statistics
  * Processing is delegated to a Virtual Warehouse
  * The Cloud Services Layer also handles queries that depend on Metadata only (no Warehouse required), e.g.:
    * Retrieve or modify the session context
    * Retrieve metadata about objects (users, warehouses, databases)
    * Get statistics, e.g.: `MIN` and `MAX` of a column, `COUNT`, number of `NULL`s
    * DDL retrieval
* Metadata and Statistics collected and kept up-to-date
* Time Travel and Cloning
* Availability
* Transparent online updates and patches
* Runs on Snowflake-managed compute
